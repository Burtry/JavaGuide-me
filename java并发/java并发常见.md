# Java并发



## 线程与进程

进程是程序的一次执行过程，是系统运行程序的基本单位。

而线程与进程相似，但线程是一个比进程更小的执行单位。一个进程在执行的过程中可以产生多个线程。

与进程不同的是**同类的多个线程共享**进程的堆和方法区资源。但每个线程都有自己的程序计数器、虚拟机栈和本地方法栈。

线程称为轻量级的进程。（负担要比进程小得多）





## 简要描述线程与进程的关系、区别及优缺点

![71610367011](assets/1716103670115.png)

上图为Java内存区域，我们从 JVM 的角度来说一下线程和进程之间的关系。



一个进程有多个线程，多个线程共享进程中的堆和方法区资源(元空间)，但每个线程都会有自己的程序计数器、虚拟机栈和本地方法栈。

**线程是进程划分成的更小的运行单位。线程和进程最大的不同在于基本上各进程是独立的，而各线程则不一定，因为同一进程中的线程极有可能会相互影响。线程执行开销小，但不利于资源的管理和保护；而进程正相反。**



为什么程序计数器私有?

程序计数器主要有下面两个作用：

1. 字节码解释器通过改变程序计数器来依次读取指令，从而实现代码的流程控制，如：顺序执行、选择、循环、异常处理。
2. 在多线程的情况下，程序计数器用于记录当前线程执行的位置，从而当线程被切换回来的时候能够知道该线程上次运行到哪儿了。

程序计数器私有主要是为了**线程切换后能恢复到正确的执行位置**。



虚拟机栈和本地方法栈为什么是私有的?

为了**保证线程中的局部变量不被别的线程访问到**



堆和方法区是所有线程共享的资源，其中堆是进程中最大的一块内存，主要用于存放新创建的对象 (几乎所有对象都在这里分配内存)，方法区主要用于存放已被加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。



## 如何创建线程

一般来说，创建线程有很多种方式，例如继承`Thread`类、实现`Runnable`接口、实现`Callable`接口、使用线程池、使用`CompletableFuture`类等等。

不过，这些方式其实并没有真正创建出线程。准确点来说，这些都属于是在 Java 代码中使用多线程的方法。

严格来说，Java 就只有一种方式可以创建线程，那就是通过`new Thread().start()`创建。不管是哪种方式，最终还是依赖于`new Thread().start()`。

详解:https://mp.weixin.qq.com/s/NspUsyhEmKnJ-4OprRFp9g



## 线程的上下文切换




上下文是指线程执行过程中的状态和运行条件。



- 主动让出 CPU，比如调用了 `sleep()`, `wait()` 等。
- 时间片用完，因为操作系统要防止一个线程或者进程长时间占用 CPU 导致其他线程或者进程饿死。
- 调用了阻塞类型的系统中断，比如请求 IO，线程被阻塞。



这三种都会发生线程切换，线程切换意味着需要保存当前线程的上下文，留待线程下次占用 CPU 的时候恢复现场。并加载下一个将要占用 CPU 的线程上下文。这就是所谓的 上下文切换。





## 可以直接调用 Thread 类的 run 方法吗？

new 一个Thread，线程进入了新建状态，调用start()方法，会启动一个线程并使线程进入了就绪状态。当分配到时间片后就可以开始运行了。start()会执行线程的相应准备工作，然后自动执行run()方法的内容。这是真正多线程工作。而直接执行run()方法，会把run()方法当成一个main线程下的普通方法去执行，并不会在某个线程中执行它，所以这不是多线程执行。



**总结：调用start()方法可启动线程并使线程进入就绪状态，直接执行run()方法的话不会以多线程的方式执行。**



